---
title: "Exploratory"
author: "Sarasati Palawita"
date: "28 December 2018"
output: html_document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, include=FALSE}
library(dplyr) 
library(ggplot2) #visualizations
library(gridExtra) #viewing multiple plots together
library(tidytext) #text mining
library(wordcloud2) #creative visualizations
library(kableExtra)
library(knitr)
library(formattable)
library(wordcloud2)
library(stringr)
library(readxl)
```

Read data
```{r lyrics_data}
setwd("C:/Users/Sarasati Palawita/Documents/Personal/BIPM 2017/Master Thesis 2018/Data")
cleaned_data = read_excel("cleaned_data_en.xlsx")
setwd("C:/Users/Sarasati Palawita/Documents/Personal/BIPM 2017/Master Thesis 2018/Data")
cleaned_data_all = read_excel("cleaned_data_all.xlsx")
setwd("C:/Users/Sarasati Palawita/Documents/Personal/BIPM 2017/Master Thesis 2018/Data")
lyrics = read_excel("lyrics.xlsx")
lyrics_all <- lyrics
cleaned_data$lyrics <- as.character(cleaned_data$lyrics)
cleaned_data_all$lyrics <- as.character(cleaned_data_all$lyrics)
lyrics_all$lyrics <- as.character(lyrics_all$lyrics)
cleaned_data = na.omit(cleaned_data)
cleaned_data_all = na.omit(cleaned_data_all)
lyrics_all = na.omit(lyrics_all)
cleaned_data <- as_tibble(cleaned_data)
cleaned_data_all <- as_tibble(cleaned_data_all)
lyrics_all <- as_tibble(lyrics_all)
class(cleaned_data)
class(cleaned_data_all)
class(lyrics_all)
exploration_data <- cleaned_data
exploration_data_all <- cleaned_data_all

```

Class Distribution 
```{r}
genre_distribution <- lyrics_all %>%
  mutate(genre = ifelse(genre == "Pop", "Pop",
                 ifelse(genre == "Jazz", "Jz",
                 ifelse(genre == "Rock", "Rck",
                 ifelse(genre == "Hip-Hop", "Hp",
                 ifelse(genre == "Metal", "Met",
                 ifelse(genre == "Electronic", "El",
                 ifelse(genre == "R&B", "R&b",
                 ifelse(genre == "Indie", "In",
                 ifelse(genre == "Country", "Cty",
                 ifelse(genre == "Folk", "Flk", genre)))))))))))
  
barplot(prop.table(table(genre_distribution$genre)),
        col = rainbow(5),
        ylim = c(0, 0.7),
        main = "Language Distribution")

```

Data Conditioning
```{r lyrics_song$lyrics}

# function to expand contractions in an English-language source
fix.contractions <- function(doc) {
  # "won't" is a special case as it does not expand to "wo not"
  doc <- gsub("won't", "will not", doc)
  doc <- gsub("can't", "can not", doc)
  doc <- gsub("n't", " not", doc)
  doc <- gsub("'ll", " will", doc)
  doc <- gsub("'re", " are", doc)
  doc <- gsub("'ve", " have", doc)
  doc <- gsub("'m", " am", doc)
  doc <- gsub("'d", " would", doc)
  # 's could be 'is' or could be possessive: it has no expansion
  doc <- gsub("'s", "", doc)
  return(doc)
}
exploration_data$lyrics <- sapply(exploration_data$lyrics, fix.contractions)
exploration_data_all$lyrics <- sapply(exploration_data_all$lyrics, fix.contractions)
lyrics_all$lyrics <- sapply(exploration_data$lyrics, fix.contractions)
```

To get rid of special characters
```{r removeSpecialChars}
# Training data - function to remove special characters
removeSpecialChars <- function(x) gsub("[^a-zA-Z0-9 ]", " ", x)
# remove special characters
lyrics_all$lyrics <- sapply(lyrics_all$lyrics, removeSpecialChars)
# convert everything to lower case
lyrics_all$lyrics <- sapply(lyrics_all$lyrics, tolower)

# remove special characters
exploration_data_all$lyrics <- sapply(exploration_data_all$lyrics, removeSpecialChars)
# convert everything to lower case
exploration_data_all$lyrics <- sapply(exploration_data_all$lyrics, tolower)
#lyrics <- lyrics[]

```

To get rid of undesirable words
```{r undesirable_words}
undesirable_words <- c("chorus", "repeat", "lyrics", "intro", "clichÃfÂ©s", "alright",
                       "theres", "bridge", "fe0f", "wanna", "gonna",
                       "chorus", "verse", "[chorus]", "[verse]",
                       "2", "2x", "3x", "1x", "repeats",
                       "4", "ooh", "uurh", "uuh", "pheromone", "poompoom", "3121", 
                       "matic", " ai ", " ca ", " la ", " na ", 
                       " da ", " uh ", " tin ", "  ll", "transcription", "YoncÃfÂ©", "BeyoncÃfÂ©")
```
N-gram
To get a fact about the dataset
```{r}
#get facts about the full dataset
summary(exploration_data_all)
#create the decade column
lyrics_all <- lyrics_all %>%
  mutate(decade = 
           ifelse(lyrics_all$year %in% 1978:1979, "1970s", 
           ifelse(lyrics_all$year %in% 1980:1989, "1980s", 
           ifelse(lyrics_all$year %in% 1990:1999, "1990s", 
           ifelse(lyrics_all$year %in% 2000:2009, "2000s", 
           ifelse(lyrics_all$year %in% 2010:2015, "2010s", 
                  "NA"))))))
```

Save file
```{r}
#save the new dataset to .csv for use in later tutorials
write.csv(lyrics_song, file = "C:/Users/Sarasati Palawita/Documents/Personal/BIPM 2017/Master Thesis 2018/Data/lyrics_new.csv")
```

Visualisation
```{r colors}
#define some colors to use throughout
colors <- c("#E69F00", "#56B4E9", "#009E73", "#CC79A7", "#FF1234")

theme_lyrics <- function() 
{
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank(), 
        axis.ticks = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")
}
```


```{r}
lyrics_all %>%
  filter(decade != "NA") %>%
  group_by(decade, genre) %>%
  summarise(number_of_songs = n()) %>%
  ggplot() + 
  geom_bar(aes(x = decade, y = number_of_songs, 
               fill = genre), stat = "identity")  +
  theme(plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        panel.grid.minor = element_blank()) +
  ggtitle("Genre per Decade") +
  labs(x = NULL, y = "Song Count")
str(lyrics_song)
```

Tokenize - Filtered Lyric
```{r lyrics_words_filter, dependson=lyric_song}
#unnest and remove stop, undesirable and short words
lyrics_words_filter <- exploration_data_all%>%
  unnest_tokens(word, lyrics) %>%
  anti_join(stop_words) %>%
  distinct()%>%
  filter(!word %in% undesirable_words) %>%
  filter(nchar(word) > 3)
```

Tokenize - Non-Filtered Lyric
```{r}
lyrics_words_nonfilter <- exploration_data %>%
  unnest_tokens(word, lyrics) %>%
  distinct()%>%
  #filter(!word %in% undesirable_words) %>%
  filter(nchar(word) > 3)
```

Total song per genre -
```{r full_song_count, dependson=lyrics_song}
library(formattable)
library(kableExtra)
full_song_count <- lyrics_words_filter %>%
  group_by(genre) %>%
  mutate(song_len = length(song)) %>%
  summarize(total_song = sum(song_len))
View(full_song_count)
full_song_count[1:10,] %>%
  ungroup(total_song, genre) %>%
  mutate(total_song = color_bar("lightblue")(total_song)) %>%
  mutate(genre = color_tile("lightpink","lightpink")(genre)) %>%
  kable("html", escape = FALSE, align = "c", caption = "Genre With Highest Word Count") %>%
  kable_styling(bootstrap_options = 
                  c("striped", "condensed", "bordered"), 
                                    full_width = FALSE)
                  
```

Word Frequency
Word count per genre -> should be average word per genre
```{r full_word_count, dependson=lyrics_song}
library(formattable)
library(kableExtra)
full_word_count <- lyrics_words_filter %>%
  #unnest_tokens(word, lyrics) %>%
  group_by(genre) %>%
  summarise(num_words = n()) %>%
  arrange(desc(num_words)) 

full_word_count[1:10,] %>%
  ungroup(num_words, genre) %>%
  mutate(num_words = color_bar("lightblue")(num_words)) %>%
  mutate(genre = color_tile("lightpink","lightpink")(genre)) %>%
  kable("html", escape = FALSE, align = "c", caption = "Genre With Highest Word Count") %>%
  kable_styling(bootstrap_options = 
                  c("striped", "condensed", "bordered"), 
                  full_width = FALSE)
```

####!!popular_words per genre
```{r dependson=lyrics_words_filter}
popular_words <- lyrics_words_filter %>% 
  group_by(genre) %>%
  count(word, genre, sort = TRUE) %>%
  slice(seq_len(8)) %>%
  ungroup() %>%
  arrange(genre,n) %>%
  mutate(row = row_number()) 

popular_words %>%
  ggplot(aes(row, n, fill = genre)) +
    geom_col(show.legend = NULL) +
    labs(x = NULL, y = "Song Count") +
    ggtitle("Popular Words by Genre") + 
    theme_lyrics() +  
    facet_wrap(~genre, scales = "free") +
    scale_x_continuous(  # This handles replacement of row 
      breaks = popular_words$row, # notice need to reuse data frame
      labels = popular_words$word) +
    coord_flip()
```

Word Count per Song
```{r dependson=lyrics_words_filter}
words_per_song <- lyrics_words_nonfilter %>% 
  group_by(genre, song) %>%
  count(word, sort = TRUE) %>%
  #ungroup() %>%
  #arrange(chart_level,n) %>%
  mutate(row = row_number())
```

Word cloud for genre = Folk
```{r lyrics_words_counts, dependson=lyrics_words_filter}
lyrics_words_counts <- lyrics_words_filter %>%
  filter(genre == "Folk") %>%
  count(word, sort = TRUE) 

wordcloud2(lyrics_words_counts[1:100, ], size = .5)
```

Timeless Word
```{r}
timeless_words <- lyrics_words_filter %>%
  group_by(decade) %>%
  filter(decade != 'NA') %>%
  count(word, decade, sort = TRUE) %>%
  slice(seq_len(10)) %>% #consider top_n() from dplyr also
  ungroup() %>%
  arrange(decade, n) %>%
  mutate(row = row_number())

View(timeless_words)

timeless_words %>%
  ggplot(aes(row, n, fill = decade)) +
    geom_col(show.legend = NULL) +
    labs(x = NULL, y = "Song Count") +
    ggtitle("Timeless Words") + 
    theme_lyrics() +  
    facet_wrap(~decade, scales = "free") +
    scale_x_continuous(  # This handles replacement of row 
      breaks = timeless_words$row, # notice need to reuse data frame
      labels = timeless_words$word) +
    coord_flip()
```
